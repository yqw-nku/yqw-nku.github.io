---
title: 限流模式
date: 2023-12-05 10:03:08
categories:
- 方案设计
tags:
- 高可用
- 高并发
---

# 限流的目标和模式

任何一个系统的运算、存储、网络资源都不是无限的，当系统资源不足以支撑外部超过预期的突发流量时，就应该要有取舍，建立面对超额流量自我保护的机制：“限流”。

为了方便后续行文，先假定一个问题场景，后续围绕这个问题场景来说明限流的意义以及限流的手段。

## 问题场景

场景1：假定有一台服务器，接入了100终端。每个终端每秒会向服务器请求执行1次业务，服务器每秒可以处理90次业务，每个业务超时时间是5s。最坏的情况下，可能会有10个终端在这5s内阻塞等待，影响终端正常业务。同时，服务器带宽资源也存在浪费。

场景2：假定有一台服务器，接入了100终端。每个终端每秒会向服务器请求执行1次业务A。服务器上除了业务A外，还存在诸多其他业务。在不限制资源的情况下，服务器每秒可以处理1000次业务A。这样看似满足了业务A的需求，但是会导致服务器上的带宽、CPU、内存以及磁盘I/O等都被业务A所占用，其余业务无法正常响应。

为了避免上述问题出现，需要进行恰当的流量控制。从以下几个方面考量：

- 限流的指标是什么：什么情况下要限流？要限制什么流量？要限制到多大流量？
- 限流的策略是什么：对于无法处理的请求/流量，是选择拒绝服务（否决式限流）还是进入队列等待被执行（阻塞式限流）；
- 限流的手段是什么：常见的限流手段有固定时间窗口模式、滑动窗口模式、漏桶模式、令牌桶模式。

## 流量指标

常见的流量指标有TPS、HPS、QPS。

- 每秒事务数（Transactions per Second，TPS）TPS 是衡量信息系统吞吐量的最终标准。“事务”可以理解为一个逻辑上具备原子性的业务操作。比如你在Bookstore 买了一本书要进行支付，这个“支付”就是一笔业务操作，无论支付成功还是不成功，这个操作在逻辑上就是原子的，即逻辑上不可能让你买本书可以成功支付前面 200 页，但失败了后面 300 页。
- 每秒请求数（Hits per Second，HPS）：HPS 是指每秒从客户端发向服务端的请求数（这里你要把 Hits 理解为 Requests 而不是 Clicks，国内某些翻译把它理解为“每秒点击数”多少有点望文生义的嫌疑）。如果只要一个请求就能完成一笔业务，那 HPS 与 TPS 是等价的，但在一些场景里（尤其常见于网页中），一笔业务可能需要多次请求才能完成。比如你在 Fenix's Bookstore 买了一本书要进行支付，尽管在操作逻辑上它是原子的，但在技术实现上，除非你是直接在银行开的商城中购物能够直接扣款，否则这个操作就很难在一次请求里完成，总要经过显示支付二维码、扫码付款、校验支付是否成功等过程，中间不可避免地会发生多次请求
- 每秒查询数（Queries per Second，QPS）：QPS 是指一台服务器能够响应的查询次数。如果只有一台服务器来应答请求，那 QPS 和 HPS 是等价的，但在分布式系统中，一个请求的响应，往往要由后台多个服务节点共同协作来完成。比如你在Bookstore 买了一本书要进行支付，在扫描支付二维码时，尽管客户端只发送了一个请求，但在这背后，服务端很可能需要向仓储服务确认库存信息避免超卖、向支付服务发送指令划转货款、向用户服务修改用户的购物积分，等等，这里面每次的内部访问，都要消耗掉一次或多次查询数。

总体来说，以上这三点都是基于调用计数的指标，而在整体目标上，我们当然最希望能够基于 TPS 来限流，因为信息系统最终是为人类用户提供服务的，用户并不关心业务到底是由多少个请求、多少个后台查询共同协作来实现的。

## 限流模式

### 固定时间窗口模式

### 滑动时间窗口模式

### 漏桶模式

### 令牌桶模式







